var path = require("path"),
    fs = require('fs'),
    Beautifier = require('node-js-beautify'),
    b = new Beautifier();

var routerDict = {
    
    '/' : 
    {
        type: 'get',
        method: 
            function(req, res) {
                res.sendFile(path.join(global.workDir ,'/site/index.html'));
            }
          },
    '/messages': 
    {
        type: 'get',
        method: 
            function(req,res) {
              var data = require('data.json');
              res.setHeader('Content-Type', 'application/json');
              res.send(JSON.stringify(data));
            }
        
    },
    '/postMessage':
    {
        type: 'post',
        method: 
            function(req, res) {
              var data;
              try {
                 data = require('data.json');
              } catch(e) {
                data = [];
              }
              var newid = (data.map((item) => {return item.id}).sort((a,b) => {return a > b ? -1 : 1})[0] + 1) || 1;
              req.body.id = newid;
              data.push(req.body);
              fs.writeFile('./node_modules/data.json', (b.beautify_js(JSON.stringify(data), {})));
              res.setHeader('Content-Type', 'application/json');
              res.send(JSON.stringify(data));
            }            
    }
    
}


module.exports = function(app) {
   for(var e in routerDict) {
    switch(routerDict[e].type) {
        case 'get':
            app.get(e, routerDict[e].method);
            break;
        case 'post':
            app.post(e, routerDict[e].method);
            break;
    }
   } 
}




