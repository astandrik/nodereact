var path = require("path"),
    fs = require('fs'),
    Beautifier = require('node-js-beautify'),
    b = new Beautifier(),
    dataPath = './data.json';

var emitter;
var routerDict = {

    '/' :
    {
        type: 'get',
        method:
            function(req, res) {
                res.sendFile(path.join(global.workDir ,'/site/index.html'));
            }
          },
    '/messages':
    {
        type: 'get',
        method:
            function(req,res) {
            fs.readFile(dataPath, 'utf8', function(err, data) {
                data = JSON.parse(data);
                res.setHeader('Content-Type', 'application/json');
                res.send(JSON.stringify(data.messages || []));
              });
            }

    },
    '/postMessage':
    {
        type: 'post',
        method:
            function(req, res) {
              fs.readFile(dataPath,'utf8', function(err, data) {
                if(data) {
                  data = JSON.parse(data);
                  var newid = (data.messages.map((item) => {return item.id}).sort((a,b) => {return a > b ? -1 : 1})[0] + 1) || 1;
                  req.body.id = newid;
                  data.messages.push(req.body);
                  fs.writeFile(dataPath, (b.beautify_js(JSON.stringify(data), {})));
                }
                res.setHeader('Content-Type', 'application/json');
                res.send(JSON.stringify(data.messages || []));
                emitter.emit('messagesUpdated');
            });
          }
    },
    '/deleteMessage':
    {
      type: 'post',
      method: function(req,res) {
        var toDeleteId = req.body.id;
        var data;
        fs.readFile(dataPath,'utf8', function(err, data) {
          if(data) {
            data = JSON.parse(data);
            data.messages = data.messages.filter((item) => {return item.id != toDeleteId});
            fs.writeFile(dataPath, (b.beautify_js(JSON.stringify(data), {})));
          }
            res.setHeader('Content-Type', 'application/json');
            res.send(JSON.stringify(data.messages || []));
            emitter.emit('messagesUpdated');
        });

      }
    },
    '/users' :
    {
      type: 'get',
      method: function(req,res) {
        fs.readFile(dataPath, 'utf8', function(err, data) {
            data = JSON.parse(data);
            res.setHeader('Content-Type', 'application/json');
            res.send(JSON.stringify(data.users || []));
          });
      }
    }

}


module.exports = function(app, func) {
   emitter = func;
   for(var e in routerDict) {
    switch(routerDict[e].type) {
        case 'get':
            app.get(e, routerDict[e].method);
            break;
        case 'post':
            app.post(e, routerDict[e].method);
            break;
    }
   }
}
